version: '3.8'

services:
  # ========== API GATEWAY ==========
  api-gateway:
    build:
      context: ./api-gateway          # aseg√∫rate que el folder se llama igual
      dockerfile: Dockerfile
    container_name: frog-api-gateway
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      # üëá URLs internas usando los puertos que definiste
      - ASSIGNMENTS_SERVICE_URL=http://assignments-service:8002
      - EXECUTION_SERVICE_URL=http://execution-service:8003
      - PLAGIARISM_SERVICE_URL=http://plagiarism-service:8004
      - LMS_SERVICE_URL=http://lms-integration:8005
    volumes:
      - ./api-gateway/app:/app/app
      - ./api-gateway/secrets:/app/secrets
    networks:
      - frog-network
    restart: unless-stopped
    depends_on:
      - assignments-service
      - execution-service
      - plagiarism-service
      - lms-integration

  # ========== ASSIGNMENTS SERVICE ==========
  assignments-service:
    build:
      context: ./assignments-service
      dockerfile: Dockerfile
    container_name: frog-assignments-service
    # ‚¨áÔ∏è contenedor escucha en 8002 y exponemos 8002
    ports:
      - "8002:8002"
    env_file:
      - ./assignments-service/.env
    environment:
      - PORT=8002
      - SERVICE_NAME=assignments-service
      # ruta dentro del contenedor al key de Firebase
      - FIREBASE_CREDENTIALS=/app/firebasekey.json
    volumes:
      - ./assignments-service/app:/app/app
      # montamos el json de firebase en /app/firebasekey.json
      - ./assignments-service/firebasekey.json:/app/firebasekey.json:ro
    networks:
      - frog-network
    restart: unless-stopped

  # ========== EXECUTION SERVICE ==========
  execution-service:
    build:
      context: ./execution-service
      dockerfile: Dockerfile
    container_name: frog-execution-service
    ports:
      - "8003:8003"
    env_file:
      - ./execution-service/.env
    environment:
      - PORT=8003
      - SERVICE_NAME=execution-service
    volumes:
      - ./execution-service/app:/app/app
      - ./execution-service/secrets:/app/secrets
    networks:
      - frog-network
    restart: unless-stopped

  # ========== PLAGIARISM SERVICE ==========
  plagiarism-service:
    build:
      context: ./plagiarism-service
      dockerfile: Dockerfile
    container_name: frog-plagiarism-service
    ports:
      - "8004:8004"
    env_file:
      - ./plagiarism-service/.env
    environment:
      - PORT=8004
      - SERVICE_NAME=plagiarism-service
      - TURNITIN_API_URL=${TURNITIN_API_URL}
      - TURNITIN_API_KEY=${TURNITIN_API_KEY}
    volumes:
      - ./plagiarism-service/app:/app/app
      - ./plagiarism-service/secrets:/app/secrets
    networks:
      - frog-network
    restart: unless-stopped

  # ========== LMS INTEGRATION ==========
  lms-integration:
    build:
      context: ./lms-integration
      dockerfile: Dockerfile
    container_name: frog-lms-integration
    # ‚¨áÔ∏è contenedor escucha en 8005 y exponemos 8005
    ports:
      - "8005:8005"
    env_file:
      - ./lms-integration/.env
    environment:
      - PORT=8005
      - SERVICE_NAME=lms-integration
      # este servicio necesita llamar al assignments-service
      - ASSIGNMENTS_SERVICE_URL=http://assignments-service:8002
      - LMS_TYPE=${LMS_TYPE:-moodle}
      - LMS_API_URL=${LMS_API_URL}
      - LMS_API_KEY=${LMS_API_KEY}
      # si en tu c√≥digo usas una key tipo Firebase / Google:
      - FIREBASE_CREDENTIALS=/app/lms-service-key.json
    volumes:
      - ./lms-integration/app:/app/app
      # montamos la key espec√≠fica del servicio LMS (si la usas)
      - ./lms-integration/lms-service-key.json:/app/lms-service-key.json:ro
    networks:
      - frog-network
    restart: unless-stopped

networks:
  frog-network:
    driver: bridge
